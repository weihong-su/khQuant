# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

---

## é¡¹ç›®æ¦‚è¿°

**khQuantï¼ˆçœ‹æµ·é‡åŒ–å›æµ‹å¹³å°ï¼‰** æ˜¯ä¸€ä¸ªåŸºäºPython+PyQt5çš„Aè‚¡é‡åŒ–äº¤æ˜“å›æµ‹ç³»ç»Ÿï¼Œæ”¯æŒæœ¬åœ°åŒ–éƒ¨ç½²ã€å›¾å½¢åŒ–æ“ä½œã€çµæ´»çš„ç­–ç•¥å¼€å‘ã€‚

**ç‰ˆæœ¬**: V2.2.0
**æŠ€æœ¯æ ˆ**: Python 3.8+, PyQt5, pandas, xtquant(MiniQMT), mootdx(å¯é€‰)
**é¡¹ç›®ç±»å‹**: å¼€æºå…è´¹é‡åŒ–äº¤æ˜“å¹³å°
**æ ¸å¿ƒä¾èµ–**: MiniQMT (åˆ¸å•†äº¤æ˜“ç»ˆç«¯)

---

## å¿«é€Ÿå¯åŠ¨å‘½ä»¤

### ç¯å¢ƒè®¾ç½®
```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# éªŒè¯ç¯å¢ƒï¼ˆæ¨èé¦–æ¬¡è¿è¡Œï¼‰
python check_dependencies.py
python tests/quick_test.py  # V2.2.0æ–°å¢å¿«é€ŸéªŒè¯

# æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
python -c "from version import get_version_info; print(get_version_info())"
```

### å¯åŠ¨åº”ç”¨
```bash
# ä¸»ç•Œé¢ï¼ˆç­–ç•¥å›æµ‹ï¼‰
python GUIkhQuant.py

# æ•°æ®ä¸‹è½½ç•Œé¢
python GUI.py

# æ•°æ®æŸ¥çœ‹å™¨
python run_data_viewer.py

# å®šæ—¶æ•°æ®è¡¥å……
python run_scheduled_supplement.py
```

### è¿è¡Œæµ‹è¯•
```bash
# å•å…ƒæµ‹è¯•
python test_settings.py          # æµ‹è¯•ç³»ç»Ÿè®¾ç½®
python test_date_formats.py      # æµ‹è¯•æ—¥æœŸæ ¼å¼
python test_record_count.py      # æµ‹è¯•æ•°æ®ç»Ÿè®¡

# æ•°æ®æä¾›è€…æµ‹è¯•ï¼ˆV2.2.0ï¼‰
python tests/test_data_provider.py      # å®Œæ•´å•å…ƒæµ‹è¯•å¥—ä»¶
python tests/benchmark_data_provider.py # æ€§èƒ½åŸºå‡†å¯¹æ¯”
```

---

## æ ¸å¿ƒæ¶æ„

### ä¸‰å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UIå±‚ (PyQt5)                                   â”‚
â”‚  - GUIkhQuant.py: ä¸»ç•Œé¢æ§åˆ¶å™¨                  â”‚
â”‚  - QThreadå¼‚æ­¥æ‰§è¡Œç­–ç•¥                          â”‚
â”‚  - pyqtSignalè·¨çº¿ç¨‹é€šä¿¡                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¡†æ¶å±‚ (ç­–ç•¥å¼•æ“)                              â”‚
â”‚  - khFrame.py: ç­–ç•¥æ‰§è¡Œå¼•æ“                     â”‚
â”‚  - TriggerFactory: è§¦å‘å™¨å·¥å‚ï¼ˆå·¥å‚æ¨¡å¼ï¼‰       â”‚
â”‚  - å›æµ‹å¾ªç¯æ§åˆ¶                                 â”‚
â”‚  - ç­–ç•¥ç”Ÿå‘½å‘¨æœŸç®¡ç†                             â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  äº¤æ˜“å±‚        â”‚    â”‚  å·¥å…·å±‚                â”‚
â”‚  khTrade.py    â”‚    â”‚  khQTTools.py          â”‚
â”‚  - è®¢å•ç®¡ç†    â”‚    â”‚  - æ•°æ®è·å–            â”‚
â”‚  - æˆæœ¬è®¡ç®—    â”‚    â”‚  - äº¤æ˜“æ—¥åˆ¤æ–­          â”‚
â”‚  - æŒä»“ç®¡ç†    â”‚    â”‚  - ä¾¿æ·å‡½æ•°            â”‚
â”‚  - T+1æ¨¡æ‹Ÿ     â”‚    â”‚  MyTT.py (æŠ€æœ¯æŒ‡æ ‡åº“)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®æŠ½è±¡å±‚ (V2.2.0æ–°å¢)                      â”‚
â”‚  khDataProvider.py                            â”‚
â”‚  - DataProviderInterface (ç»Ÿä¸€æ¥å£)          â”‚
â”‚  - DataProviderFactory (å·¥å‚æ¨¡å¼)            â”‚
â”‚  - XtQuantAdapter / MootdxAdapter            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  xtquant          â”‚  â”‚  mootdx               â”‚
â”‚  (MiniQMT)        â”‚  â”‚  (é€šè¾¾ä¿¡)             â”‚
â”‚  - å®ç›˜/æ¨¡æ‹Ÿäº¤æ˜“  â”‚  â”‚  - å›æµ‹å†å²æ•°æ®       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç­–ç•¥æ‰§è¡Œæµç¨‹

```
åˆå§‹åŒ–é˜¶æ®µ:
  khFrame.__init__()
    â†“
  TriggerFactory.create_trigger()  # å·¥å‚æ¨¡å¼åˆ›å»ºè§¦å‘å™¨
    â†“
  KhTradeManager()  # è™šæ‹Ÿè´¦æˆ·åˆå§‹åŒ–
    â†“
  strategy.init()  # ç”¨æˆ·ç­–ç•¥åˆå§‹åŒ–

æ•°æ®åŠ è½½é˜¶æ®µ:
  DataProvider.get_market_data()  # æ‰¹é‡åŠ è½½å†å²æ•°æ®
    â†“
  æ„å»ºæ—¶é—´åºåˆ—ç´¢å¼•

å›æµ‹å¾ªç¯ (for timestamp in timeline):
  â”œâ”€ æ—¥æœŸåˆ‡æ¢æ£€æµ‹
  â”‚   â”œâ”€ khPostMarket(data)  # å‰ä¸€æ—¥æ”¶ç›˜å
  â”‚   â””â”€ khPreMarket(data)   # æ–°ä¸€æ—¥å¼€ç›˜å‰
  â”‚
  â”œâ”€ æ„å»ºæ•°æ®å­—å…¸
  â”‚   â”œâ”€ __current_time__    # æ—¶é—´ä¿¡æ¯
  â”‚   â”œâ”€ __account__         # è´¦æˆ·ä¿¡æ¯
  â”‚   â”œâ”€ __positions__       # æŒä»“ä¿¡æ¯
  â”‚   â”œâ”€ __stock_list__      # è‚¡ç¥¨æ± 
  â”‚   â””â”€ {è‚¡ç¥¨ä»£ç : Series}  # è¡Œæƒ…æ•°æ®
  â”‚
  â”œâ”€ trigger.should_trigger()  # è§¦å‘å™¨åˆ¤æ–­
  â”œâ”€ risk_mgr.check_risk()     # é£æ§æ£€æŸ¥
  â”‚
  â”œâ”€ signals = khHandlebar(data)  # æ‰§è¡Œç­–ç•¥
  â”‚
  â”œâ”€ trade_mgr.process_signals()  # å¤„ç†äº¤æ˜“ä¿¡å·
  â”‚   â”œâ”€ è®¡ç®—äº¤æ˜“æˆæœ¬ (æ»‘ç‚¹+ä½£é‡‘+å°èŠ±ç¨+è¿‡æˆ·è´¹)
  â”‚   â”œâ”€ æ£€æŸ¥èµ„é‡‘/æŒä»“å……è¶³æ€§
  â”‚   â”œâ”€ æ›´æ–°è´¦æˆ·èµ„äº§å’ŒæŒä»“
  â”‚   â””â”€ è§¦å‘äº¤æ˜“å›è°ƒ
  â”‚
  â””â”€ è®°å½•å›æµ‹ç»“æœ

ç»“æŸé˜¶æ®µ:
  ç”Ÿæˆå›æµ‹æŠ¥å‘Š â†’ GUIå±•ç¤º
```

### è®¾è®¡æ¨¡å¼åº”ç”¨

**å·¥å‚æ¨¡å¼**:
- `TriggerFactory`: æ ¹æ®é…ç½®åŠ¨æ€åˆ›å»ºè§¦å‘å™¨ç±»å‹ (TickTrigger/KLineTrigger/DailyTrigger)
- `DataProviderFactory`: æ ¹æ®é…ç½®åˆ›å»ºæ•°æ®æºé€‚é…å™¨ (XtQuant/Mootdx)

**é€‚é…å™¨æ¨¡å¼**:
- `XtQuantAdapter`: å°è£…MiniQMTçš„xtquantæ¥å£
- `MootdxAdapter`: å°è£…é€šè¾¾ä¿¡mootdxæ¥å£
- ç»Ÿä¸€çš„`DataProviderInterface`æ¥å£

**ç­–ç•¥æ¨¡å¼**:
- `TriggerBase`: è§¦å‘å™¨åŸºç±»ï¼Œå„å­ç±»å®ç°ä¸åŒè§¦å‘é€»è¾‘

**å•ä¾‹æ¨¡å¼**:
- `DataProviderFactory`: ç¡®ä¿åŒä¸€é…ç½®è¿”å›ç›¸åŒçš„æ•°æ®æä¾›è€…å®ä¾‹

---

## ç­–ç•¥å¼€å‘å¿«é€Ÿå‚è€ƒ

### æœ€å°åŒ–ç­–ç•¥æ¨¡æ¿

```python
from khQuantImport import *

def init(stocks=None, data=None):
    """ç­–ç•¥åˆå§‹åŒ– (å¿…éœ€ä½†å¯ä¸ºç©º)"""
    pass

def khHandlebar(data: Dict) -> List[Dict]:
    """ä¸»ç­–ç•¥å‡½æ•° (æ¯ä¸ªè§¦å‘ç‚¹è°ƒç”¨)"""
    signals = []

    # 1. è·å–è‚¡ç¥¨ä»£ç 
    stock_code = khGet(data, "first_stock")

    # 2. è·å–å½“å‰ä»·æ ¼
    current_price = khPrice(data, stock_code, "close")

    # 3. è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
    ma5 = khMA(stock_code, 5)
    ma20 = khMA(stock_code, 20)

    # 4. äº¤æ˜“é€»è¾‘
    if ma5 > ma20 and not khHas(data, stock_code):
        signals = khBuy(data, stock_code, 1.0, reason="é‡‘å‰ä¹°å…¥")
    elif ma5 < ma20 and khHas(data, stock_code):
        signals = khSell(data, stock_code, 1.0, reason="æ­»å‰å–å‡º")

    return signals

# å¯é€‰å›è°ƒ
def khPreMarket(data: Dict) -> List[Dict]:
    """å¼€ç›˜å‰å›è°ƒ"""
    return []

def khPostMarket(data: Dict) -> List[Dict]:
    """æ”¶ç›˜åå›è°ƒ"""
    return []
```

### æ•°æ®å­—å…¸ç»“æ„ (dataå‚æ•°)

```python
data = {
    # è‚¡ç¥¨è¡Œæƒ… (æ¯ä¸ªè‚¡ç¥¨ä¸€ä¸ªSeries)
    "000001.SZ": pd.Series({
        "time": 1727750100000,  # æ¯«ç§’æ—¶é—´æˆ³
        "open": 10.50,
        "high": 10.85,
        "low": 10.45,
        "close": 10.80,
        "volume": 1234567,
        "amount": 13246789.0
    }),

    # æ—¶é—´ä¿¡æ¯
    "__current_time__": {
        "timestamp": 1727750100,      # Unixæ—¶é—´æˆ³(ç§’)
        "datetime": "2024-10-01 09:35:00",
        "date": "2024-10-01",
        "time": "09:35:00"
    },

    # è´¦æˆ·ä¿¡æ¯
    "__account__": {
        "cash": 980000.0,
        "frozen_cash": 0.0,
        "market_value": 20000.0,
        "total_asset": 1000000.0,
        "benchmark": "000300.SH"
    },

    # æŒä»“ä¿¡æ¯
    "__positions__": {
        "000001.SZ": {
            "volume": 1000,           # æ€»æŒä»“
            "can_use_volume": 1000,   # å¯å–æ•°é‡(T+1)
            "avg_price": 10.50,
            "current_price": 10.80,
            "market_value": 10800.0,
            "profit": 300.0
        }
    },

    # è‚¡ç¥¨æ± 
    "__stock_list__": ["000001.SZ", "000002.SZ"],

    # æ¡†æ¶å¼•ç”¨
    "__framework__": <KhQuantFrameworkå®ä¾‹>
}
```

### å¸¸ç”¨å·¥å…·å‡½æ•°

```python
# æ—¶é—´åˆ¤æ–­
is_trade_time()                        # æ˜¯å¦äº¤æ˜“æ—¶é—´(9:30-15:00)
is_trade_day("20241001")               # æ˜¯å¦äº¤æ˜“æ—¥
get_trade_days_count(start, end)       # è®¡ç®—äº¤æ˜“æ—¥å¤©æ•°

# æ•°æ®è·å–
khGet(data, "date")                    # è·å–å½“å‰æ—¥æœŸ
khGet(data, "time")                    # è·å–å½“å‰æ—¶é—´
khGet(data, "first_stock")             # è·å–ç¬¬ä¸€åªè‚¡ç¥¨ä»£ç 
khGet(data, "total_asset")             # è·å–æ€»èµ„äº§

khPrice(data, code, "close")           # è·å–æ”¶ç›˜ä»·
khPrice(data, code, "open")            # è·å–å¼€ç›˜ä»·

khHas(data, code)                      # æ£€æŸ¥æ˜¯å¦æŒä»“

# å†å²æ•°æ®
khHistory(
    stock_code="000001.SZ",
    period="1d",                       # "1m"/"5m"/"1d"
    count=100,                         # Kçº¿æ•°é‡
    dividend_type="front"              # å¤æƒç±»å‹
)

# æŠ€æœ¯æŒ‡æ ‡ (å°è£…)
khMA(code, n=5, period="1d")           # ç§»åŠ¨å¹³å‡çº¿

# ä¿¡å·ç”Ÿæˆ
khBuy(data, code, ratio=1.0, reason="")
khSell(data, code, ratio=1.0, reason="")
# ratio <= 1: æŒ‰ä»“ä½æ¯”ä¾‹ (1.0=æ»¡ä»“, 0.5=åŠä»“)
# ratio > 1: æŒ‰è‚¡æ•° (å¿…é¡»æ˜¯100æ•´æ•°å€)
```

### æŠ€æœ¯æŒ‡æ ‡åº“ (MyTT.py)

```python
from MyTT import *

# åŸºç¡€å‡½æ•°
REF(S, N)       # åºåˆ—åç§»Nä½
DIFF(S, N)      # å·®åˆ†
SUM(S, N)       # Næ—¥ç´¯è®¡å’Œ
HHV(S, N)       # Næ—¥æœ€é«˜ä»·
LLV(S, N)       # Næ—¥æœ€ä½ä»·
MA(S, N)        # ç®€å•ç§»åŠ¨å¹³å‡
EMA(S, N)       # æŒ‡æ•°ç§»åŠ¨å¹³å‡
STD(S, N)       # æ ‡å‡†å·®

# åº”ç”¨å‡½æ•°
COUNT(S, N)     # Næ—¥å†…æ»¡è¶³æ¡ä»¶æ¬¡æ•°
EVERY(S, N)     # Næ—¥å†…å…¨éƒ¨æ»¡è¶³
EXIST(S, N)     # Næ—¥å†…å­˜åœ¨æ»¡è¶³
CROSS(S1, S2)   # S1ä¸Šç©¿S2 (é‡‘å‰)

# æŠ€æœ¯æŒ‡æ ‡
BOLL(CLOSE, N=20, P=2)              # å¸ƒæ—å¸¦
MACD(CLOSE, SHORT=12, LONG=26, M=9) # MACD
KDJ(CLOSE, HIGH, LOW, N=9, M1=3, M2=3) # KDJ
RSI(CLOSE, N=14)                    # RSI
CCI(CLOSE, HIGH, LOW, N=14)         # CCI
ATR(CLOSE, HIGH, LOW, N=14)         # ATR

# ä½¿ç”¨ç¤ºä¾‹
hist = khHistory("000001.SZ", "1d", count=100)
ma5 = MA(hist['close'], 5)
ma20 = MA(hist['close'], 20)
if CROSS(ma5, ma20).iloc[-1]:
    print("é‡‘å‰ä¿¡å·")
```

---

## é…ç½®æ–‡ä»¶æ ¼å¼ (.kh)

### æ ‡å‡†é…ç½®æ¨¡æ¿ (V2.2.0)

```json
{
  "system": {
    "run_mode": "backtest",
    "userdata_path": "D:/å›½é‡‘è¯åˆ¸QMTäº¤æ˜“ç«¯/userdata_mini",
    "session_id": 1234567890,
    "data_provider": {
      "type": "mootdx",
      "mootdx": {
        "mode": "online",
        "tdxdir": "",
        "use_cache": true,
        "use_xtquant_for_adjust": false
      }
    }
  },
  "account": {
    "account_id": "test_account",
    "account_type": "SECURITY_ACCOUNT"
  },
  "backtest": {
    "start_time": "20240101",
    "end_time": "20241231",
    "init_capital": 1000000,
    "benchmark": "000300.SH",
    "trigger": {
      "type": "1d",
      "pre_market": {
        "enabled": true,
        "time": "08:00:00"
      },
      "post_market": {
        "enabled": true,
        "time": "15:30:00"
      }
    },
    "trade_cost": {
      "commission_rate": 0.0003,
      "min_commission": 5.0,
      "stamp_tax_rate": 0.001,
      "flow_fee": 0.1,
      "slippage": {
        "type": "ratio",
        "ratio": 0.001
      }
    }
  },
  "data": {
    "kline_period": "1d",
    "stock_list": ["000001.SZ", "600000.SH"]
  },
  "risk": {
    "position_limit": 0.95,
    "order_limit": 100,
    "loss_limit": 0.1
  },
  "strategy_file": "strategies/åŒå‡çº¿ç­–ç•¥.py"
}
```

### æ•°æ®æºé…ç½®è¯´æ˜ (V2.2.0)

| æ•°æ®æº | é€‚ç”¨åœºæ™¯ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|--------|---------|------|------|
| **mootdx** (é»˜è®¤) | å›æµ‹ | å…è´¹ã€æ”¯æŒç¦»çº¿ã€å¤šç§æ¨¡å¼ | éœ€é¢å¤–å®‰è£… |
| **xtquant** | å›æµ‹/æ¨¡æ‹Ÿ/å®ç›˜ | å®˜æ–¹æ¥å£ã€ç¨³å®šå¯é  | éœ€MiniQMTè¿è¡Œ |

**é‡è¦è§„åˆ™**:
- âœ… å›æµ‹æ¨¡å¼ï¼šé»˜è®¤ä½¿ç”¨mootdxï¼Œå¯é…ç½®ä¸ºxtquant
- âœ… æ¨¡æ‹Ÿ/å®ç›˜æ¨¡å¼ï¼š**å¼ºåˆ¶ä½¿ç”¨xtquant** (ç¡¬ç¼–ç ï¼Œä¸å¯è¦†ç›–)
- âœ… å‘åå…¼å®¹ï¼šä¸é…ç½®data_providerçš„æ—§é…ç½®ä»å¯è¿è¡Œ

---

## å…³é”®æ³¨æ„äº‹é¡¹

### T+1åˆ¶åº¦æ¨¡æ‹Ÿ

âš ï¸ **å·²çŸ¥Bug**: å½“å‰ä»£ç åœ¨ä¹°å…¥æ—¶ç›´æ¥å¢åŠ  `can_use_volume`ï¼ˆ[khTrade.py:385](khTrade.py#L385)ï¼‰ï¼Œæœªä¸¥æ ¼å®ç°T+1åˆ¶åº¦ã€‚

**æ­£ç¡®å®ç°**:
```python
# å½“å‰å®ç°ï¼ˆé”™è¯¯ï¼‰
def _process_buy_signal():
    position["volume"] += volume
    position["can_use_volume"] += volume  # âŒ åº”è¯¥åœ¨æ—¥åˆ‡æ—¶æ›´æ–°

# æ­£ç¡®å®ç°
def _on_new_trading_day():
    for code, pos in positions.items():
        pos["can_use_volume"] = pos["volume"]  # âœ… æ—¥åˆ‡æ—¶åŒæ­¥
```

### æ•°æ®ä¸æ³„éœ²åŸåˆ™

```python
# é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨å½“å‰Baræ•°æ®
ma5 = MA(data["000001.SZ"]["close"], 5)  # åŒ…å«å½“å‰æœªå®ŒæˆBar

# æ­£ç¡®ï¼šä½¿ç”¨khHistoryè·å–å†å²æ•°æ®
hist = khHistory("000001.SZ", "1d", count=10)  # ä¸åŒ…å«å½“å‰æ—¥
ma5 = MA(hist['close'], 5)
```

### å¤šçº¿ç¨‹å®‰å…¨

- ç­–ç•¥åœ¨ç‹¬ç«‹ `QThread` ä¸­è¿è¡Œ
- ä½¿ç”¨ `pyqtSignal` è·¨çº¿ç¨‹ä¼ é€’æ•°æ®
- å­è¿›ç¨‹è‡ªåŠ¨è®¾ç½® `QT_QPA_PLATFORM=offscreen`

### è‚¡ç¥¨ä»£ç æ ¼å¼

**æ ‡å‡†æ ¼å¼**: `å¸‚åœºä»£ç .è‚¡ç¥¨ä»£ç `
- ä¸Šæµ·: `600000.SH`, `601318.SH`
- æ·±åœ³: `000001.SZ`, `300001.SZ`

ç³»ç»Ÿè‡ªåŠ¨æ ‡å‡†åŒ–ä»£ç æ ¼å¼ (`600036` â†’ `600036.SH`)

---

## å¸¸è§å¼€å‘ä»»åŠ¡

### åˆ›å»ºæ–°ç­–ç•¥

1. åœ¨ `strategies/` ç›®å½•åˆ›å»ºç­–ç•¥æ–‡ä»¶ (Python)
2. åˆ›å»ºå¯¹åº”é…ç½®æ–‡ä»¶ (.kh)
3. é€šè¿‡GUIåŠ è½½å¹¶è¿è¡Œ

### è°ƒè¯•ç­–ç•¥

```python
# æ–¹æ³•1: printè¾“å‡º (æ˜¾ç¤ºåœ¨GUIæ—¥å¿—çª—å£)
def khHandlebar(data):
    stock_code = khGet(data, "first_stock")
    price = khPrice(data, stock_code, "close")
    print(f"å½“å‰ä»·æ ¼: {price}")

# æ–¹æ³•2: æ—¥å¿—ç³»ç»Ÿ
import logging
logger = logging.getLogger(__name__)

def khHandlebar(data):
    logger.info(f"ç­–ç•¥æ‰§è¡Œ: {khGet(data, 'date')}")
    logger.debug(f"æ•°æ®å­—å…¸: {data.keys()}")

# æ–¹æ³•3: ä¿å­˜ä¸­é—´ç»“æœ
def khHandlebar(data):
    with open("debug.txt", "a") as f:
        f.write(f"{khGet(data, 'date')}: {data}\n")
```

### ä¸‹è½½å†å²æ•°æ®

```python
# æ–¹æ³•1: GUI (æ¨è)
python GUI.py

# æ–¹æ³•2: ä»£ç 
from xtquant import xtdata

xtdata.download_history_data2(
    stock_list=["000001.SZ", "600000.SH"],
    period="1d",
    start_time="20240101",
    end_time="20241231",
    incrementally=True
)
```

---

## ä»£ç ä¿®æ”¹å»ºè®®

### ä¿®æ”¹æ ¸å¿ƒæ¨¡å—æ³¨æ„äº‹é¡¹

**khFrame.py (ç­–ç•¥å¼•æ“)**:
- ä¿®æ”¹è§¦å‘å™¨é€»è¾‘å‰ç†è§£å®Œæ•´å›æµ‹å¾ªç¯
- æ·»åŠ æ–°è§¦å‘å™¨éœ€æ›´æ–°TriggerFactory
- æ³¨æ„çº¿ç¨‹å®‰å…¨ (QThread)

**khTrade.py (äº¤æ˜“ç®¡ç†)**:
- ä¿®æ”¹äº¤æ˜“æˆæœ¬å½±å“æ‰€æœ‰ç­–ç•¥å›æµ‹
- ä¿®æ”¹T+1é€»è¾‘éœ€åŒæ­¥æŒä»“ç®¡ç†
- æ³¨æ„æµ®ç‚¹æ•°ç²¾åº¦ (round 2ä½å°æ•°)

**khQTTools.py (å·¥å…·é›†)**:
- ä¿®æ”¹å‡½æ•°æ¥å£éœ€æ›´æ–°æ‰€æœ‰è°ƒç”¨å¤„
- æ–°å¢å‡½æ•°éœ€åœ¨khQuantImport.pyå¯¼å‡º
- æ³¨æ„å­è¿›ç¨‹å…¼å®¹æ€§

**MyTT.py (æŠ€æœ¯æŒ‡æ ‡åº“)**:
- ä¿æŒä¸é€šè¾¾ä¿¡å…¬å¼è¯­æ³•ä¸€è‡´
- æ–°å¢æŒ‡æ ‡éœ€ç¼–å†™æµ‹è¯•ç”¨ä¾‹
- æ³¨æ„Seriesç´¢å¼•å¯¹é½

### å¸¸è§å¼€å‘é™·é˜±

**1. æ•°æ®æ³„éœ²é£é™©**:
```python
# é”™è¯¯
ma5 = MA(data["000001.SZ"]["close"], 5)  # åŒ…å«æœªå®ŒæˆBar

# æ­£ç¡®
hist = khHistory("000001.SZ", "1d", count=10)
ma5 = MA(hist['close'], 5)
```

**2. æµ®ç‚¹æ•°æ¯”è¾ƒ**:
```python
# é”™è¯¯
if price == 10.50:  # ç²¾åº¦é—®é¢˜

# æ­£ç¡®
if abs(price - 10.50) < 0.01:
```

**3. T+1è§„åˆ™é—æ¼**:
```python
# é”™è¯¯
khBuy(data, code, 1.0)
khSell(data, code, 1.0)  # å½“å¤©ä¹°å…¥æ— æ³•å–å‡º

# æ­£ç¡®
if khHas(data, code):
    position = data["__positions__"][code]
    if position["can_use_volume"] > 0:
        khSell(data, code, 1.0)
```

**4. è‚¡ç¥¨ä»£ç æ ¼å¼**:
```python
# é”™è¯¯
"000001"     # ç¼ºå°‘å¸‚åœºåç¼€
"sh600000"   # æ ¼å¼é”™è¯¯

# æ­£ç¡®
"000001.SZ"  # æ·±åœ³
"600000.SH"  # ä¸Šæµ·
```

---

## é¡¹ç›®æ–‡ä»¶ç»“æ„

```
khQuant/
â”œâ”€â”€ GUIkhQuant.py          # ä¸»ç•Œé¢ (4851è¡Œ)
â”œâ”€â”€ khFrame.py             # ç­–ç•¥å¼•æ“ (2666è¡Œ)
â”œâ”€â”€ khTrade.py             # äº¤æ˜“ç®¡ç† (560è¡Œ)
â”œâ”€â”€ khQTTools.py           # å·¥å…·é›† (2309è¡Œ)
â”œâ”€â”€ MyTT.py                # æŠ€æœ¯æŒ‡æ ‡åº“ (624è¡Œ)
â”œâ”€â”€ khQuantImport.py       # ç»Ÿä¸€å¯¼å…¥æ¨¡å— (521è¡Œ)
â”œâ”€â”€ khConfig.py            # é…ç½®ç®¡ç†
â”œâ”€â”€ khRisk.py              # é£é™©ç®¡ç†
â”œâ”€â”€ khDataProvider.py      # æ•°æ®æ¥å£æŠ½è±¡å±‚ (V2.2.0)
â”‚
â”œâ”€â”€ GUI.py                 # æ•°æ®ä¸‹è½½ç•Œé¢
â”œâ”€â”€ GUIDataViewer.py       # æ•°æ®æŸ¥çœ‹å™¨
â”œâ”€â”€ GUIScheduler.py        # å®šæ—¶ä»»åŠ¡è°ƒåº¦
â”œâ”€â”€ SettingsDialog.py      # ç³»ç»Ÿè®¾ç½®
â”œâ”€â”€ version.py             # ç‰ˆæœ¬ç®¡ç†
â”œâ”€â”€ update_manager.py      # æ›´æ–°ç®¡ç†å™¨
â”œâ”€â”€ check_dependencies.py  # ä¾èµ–æ£€æŸ¥å·¥å…·
â”‚
â”œâ”€â”€ strategies/            # ç­–ç•¥æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ *.py              # Pythonç­–ç•¥
â”‚   â””â”€â”€ *.kh              # JSONé…ç½®
â”‚
â”œâ”€â”€ tests/                 # æµ‹è¯•ç›®å½• (V2.2.0)
â”‚   â”œâ”€â”€ test_data_provider.py       # æ•°æ®æä¾›è€…å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ benchmark_data_provider.py  # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”‚   â””â”€â”€ quick_test.py               # å¿«é€ŸåŠŸèƒ½éªŒè¯
â”‚
â”œâ”€â”€ backtest_results/      # å›æµ‹ç»“æœ
â”œâ”€â”€ requirements.txt       # ä¾èµ–åˆ—è¡¨
â””â”€â”€ README.md              # ç”¨æˆ·æ‰‹å†Œ
```

---

## æ•°æ®æ¥å£æŠ½è±¡å±‚ (V2.2.0)

### æ¶æ„è®¾è®¡

ä» V2.2.0 å¼€å§‹ï¼Œå¼•å…¥æ•°æ®æ¥å£æŠ½è±¡å±‚ ([khDataProvider.py](khDataProvider.py))ï¼Œé‡‡ç”¨é€‚é…å™¨æ¨¡å¼å®ç°å¤šæ•°æ®æºæ”¯æŒã€‚

```python
from khDataProvider import DataProviderFactory

# ä½¿ç”¨ XtQuant (é»˜è®¤)
provider = DataProviderFactory.get_provider('xtquant')

# ä½¿ç”¨ Mootdx (åœ¨çº¿æ¨¡å¼)
provider = DataProviderFactory.get_provider('mootdx', mode='online')

# è·å–æ•°æ®
data = provider.get_market_data(
    stock_list=['600036.SH'],
    period='1d',
    start_time='20240101',
    end_time='20241231',
    fields=['open', 'high', 'low', 'close', 'volume'],
    dividend_type='front'
)
```

### æ”¯æŒçš„æ•°æ®æº

| æ•°æ®æº | ç±»å‹ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|-------|------|------|------|---------|
| **XtQuant** | åˆ¸å•†æ•°æ® | ç¨³å®šã€æ”¯æŒå®ç›˜ã€å¤æƒå‡†ç¡® | éœ€MiniQMTç¯å¢ƒ | å®ç›˜äº¤æ˜“ã€ç²¾ç¡®å›æµ‹ |
| **Mootdx** | é€šè¾¾ä¿¡æ•°æ® | å…è´¹ã€æ— éœ€å®¢æˆ·ç«¯ã€æ˜“ä¸Šæ‰‹ | å¤æƒæœ‰Bugã€800æ¡é™åˆ¶ | å­¦ä¹ ã€ç®€å•å›æµ‹ |

âš ï¸ **é‡è¦è¯´æ˜**:
- Mootdx **ä¸æ”¯æŒ**å®ç›˜/æ¨¡æ‹Ÿäº¤æ˜“
- å®ç›˜å’Œæ¨¡æ‹Ÿæ¨¡å¼**å¿…é¡»**ä½¿ç”¨ XtQuant
- Mootdx å¤æƒåŠŸèƒ½æœ‰å·²çŸ¥Bugï¼Œå»ºè®®æ··åˆæ¨¡å¼

---

## APIå¿«é€Ÿå‚è€ƒ

### è§¦å‘å™¨é…ç½®

| typeå€¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|--------|------|----------|
| `"tick"` | æ¯ä¸ªTickè§¦å‘ | é«˜é¢‘ç­–ç•¥ |
| `"1m"` | 1åˆ†é’ŸKçº¿è§¦å‘ | çŸ­çº¿ç­–ç•¥ |
| `"5m"` | 5åˆ†é’ŸKçº¿è§¦å‘ | æ—¥å†…ç­–ç•¥ |
| `"1d"` | æ—¥çº¿è§¦å‘ | è¶‹åŠ¿ç­–ç•¥ |
| `"custom"` | è‡ªå®šä¹‰æ—¶é—´è§¦å‘ | äº‹ä»¶é©±åŠ¨ç­–ç•¥ |

### å›è°ƒå‡½æ•°æ—¶æœº

| å‡½æ•° | è°ƒç”¨æ—¶æœº | è¿”å›å€¼ |
|------|---------|--------|
| `init(stocks, data)` | ç­–ç•¥å¯åŠ¨æ—¶ä¸€æ¬¡ | æ—  |
| `khHandlebar(data)` | æ¯ä¸ªè§¦å‘ç‚¹ | `List[Dict]` ä¿¡å·åˆ—è¡¨ |
| `khPreMarket(data)` | æ¯æ—¥å¼€ç›˜å‰ | `List[Dict]` ä¿¡å·åˆ—è¡¨ |
| `khPostMarket(data)` | æ¯æ—¥æ”¶ç›˜å | `List[Dict]` ä¿¡å·åˆ—è¡¨ |

### äº¤æ˜“å›è°ƒ

| å›è°ƒæ–¹æ³• | è§¦å‘æ—¶æœº | å‚æ•° |
|---------|---------|------|
| `on_stock_order(order)` | å§”æ‰˜ä¸‹å•æ—¶ | å§”æ‰˜ä¿¡æ¯å­—å…¸ |
| `on_stock_trade(trade)` | å§”æ‰˜æˆäº¤æ—¶ | æˆäº¤ä¿¡æ¯å­—å…¸ |
| `on_order_error(error_id, msg, order)` | å§”æ‰˜é”™è¯¯æ—¶ | é”™è¯¯ID(-1èµ„é‡‘ä¸è¶³/-2æŒä»“ä¸è¶³) |
| `on_stock_position(positions)` | æŒä»“å˜åŠ¨æ—¶ | å…¨éƒ¨æŒä»“å­—å…¸ |
| `on_stock_asset(assets)` | èµ„äº§å˜åŠ¨æ—¶ | èµ„äº§ä¿¡æ¯å­—å…¸ |

---

## å…³é”®è®¾è®¡å†³ç­–

### ä¸ºä½•ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºè§¦å‘å™¨ï¼Ÿ
- **æ‰©å±•æ€§**: è½»æ¾æ·»åŠ æ–°è§¦å‘å™¨ç±»å‹ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
- **é…ç½®é©±åŠ¨**: é€šè¿‡JSONé…ç½®åŠ¨æ€é€‰æ‹©è§¦å‘æ–¹å¼
- **è§£è€¦**: ç­–ç•¥ä»£ç ä¸è§¦å‘æœºåˆ¶åˆ†ç¦»

### ä¸ºä½•æ•°æ®å­—å…¸åŒ…å« `__framework__` å¼•ç”¨ï¼Ÿ
- å…è®¸é«˜çº§ç­–ç•¥è®¿é—®æ¡†æ¶å†…éƒ¨çŠ¶æ€
- æ”¯æŒåŠ¨æ€è°ƒæ•´å‚æ•° (å¦‚ä¿®æ”¹è‚¡ç¥¨æ± )
- æä¾›æ‰©å±•æ¥å£ (å¦‚è·å–å…¶ä»–å¸‚åœºæ•°æ®)

### ä¸ºä½•ä½¿ç”¨ç‹¬ç«‹QThreadè¿è¡Œç­–ç•¥ï¼Ÿ
- **å“åº”æ€§**: é¿å…GUIç•Œé¢å†»ç»“
- **å¯ä¸­æ–­**: æ”¯æŒç”¨æˆ·åœæ­¢ç­–ç•¥
- **ä¿¡å·é€šä¿¡**: å®æ—¶æ›´æ–°æ—¥å¿—å’Œè¿›åº¦
- **å¼‚å¸¸éš”ç¦»**: ç­–ç•¥é”™è¯¯ä¸å½±å“ä¸»ç•Œé¢

---

## è¿›ä¸€æ­¥å­¦ä¹ 

- **README.md**: å®Œæ•´ç”¨æˆ·æ‰‹å†Œ
- **é¡¹ç›®æ–‡ä»¶è¯´æ˜.md**: å„æ¨¡å—åŠŸèƒ½æ¦‚è¿°
- **ç¤ºä¾‹ç­–ç•¥**: [strategies/åŒå‡çº¿ç²¾ç®€_ä½¿ç”¨khMAå‡½æ•°.py](strategies/åŒå‡çº¿ç²¾ç®€_ä½¿ç”¨khMAå‡½æ•°.py)
- **å®˜æ–¹æ–‡æ¡£**: https://khsci.com/khQuant/tutorial/
- **æ•°æ®æ¥å£æ–‡æ¡£**: [DATA_PROVIDER_README.md](DATA_PROVIDER_README.md)

---

**æœ€åæ›´æ–°**: 2025-10-05
**é€‚ç”¨ç‰ˆæœ¬**: V2.2.0

**V2.2.2 (2025-10-05)** - CLAUDE.mdä¼˜åŒ–:
- ğŸ¯ é‡æ„æ–‡æ¡£ç»“æ„ï¼Œèšç„¦æ ¸å¿ƒæ¶æ„å’Œå¸¸ç”¨å‘½ä»¤
- âœ¨ æ–°å¢"å¿«é€Ÿå¯åŠ¨å‘½ä»¤"ç« èŠ‚ï¼Œæä¾›å®ç”¨å‘½ä»¤é€ŸæŸ¥
- ğŸ“ ç®€åŒ–æ¶æ„å›¾ï¼Œçªå‡ºä¸‰å±‚è®¾è®¡å’Œè®¾è®¡æ¨¡å¼
- ğŸ”§ æ•´åˆ"ç­–ç•¥å¼€å‘å¿«é€Ÿå‚è€ƒ"ï¼Œæä¾›å®Œæ•´ä»£ç ç¤ºä¾‹
- ğŸ“Š ä¼˜åŒ–è¡¨æ ¼å±•ç¤ºï¼Œå¢å¼ºå¯è¯»æ€§
- ğŸ”— æ·»åŠ æ–‡ä»¶è·¯å¾„å¼•ç”¨é“¾æ¥
- ğŸ—‘ï¸ ç§»é™¤å†—ä½™å†…å®¹ï¼Œå‡å°‘æ–‡æ¡£é•¿åº¦50%
- ğŸ’¡ ä¿ç•™æ‰€æœ‰å…³é”®æŠ€æœ¯ç»†èŠ‚å’Œå·²çŸ¥é—®é¢˜è¯´æ˜
